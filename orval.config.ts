import { defineConfig } from "orval";

export default defineConfig({
  api: {
    output: {
      mode: "single",
      target: "services/api/index.ts",
      client: "swr",
      override: {
        mutator: {
          path: "services/api/fetcher.ts",
          name: "orvalFetcher",
        },
        query: {
          useQuery: true,
          useInfinite: false,
          signal: true,
        },
        header: (info) => [
          "Generated by orval 🍺",
          "Do not edit manually.",
          `OpenAPI spec version: ${info.version}`,
          "",
        ],
      },
    },
    input: {
      target: "https://api.gaas.waterballsa.tw/swagger-ui/api-docs",
      validation: false,
      override: {
        transformer: (spec: any) => {
          // 要過濾的參數名稱和 schema
          const unwantedParams = ["jwt", "principal"];
          const unwantedSchemas = ["Jwt", "JwtHeaders", "JwtClaims"];

          // 遞迴清理 schema 中的屬性
          const cleanSchema = (schema: any): any => {
            if (!schema || typeof schema !== "object") return schema;

            // 處理 $ref 引用
            if (
              schema.$ref &&
              unwantedSchemas.some((name) => schema.$ref.includes(name))
            ) {
              return undefined;
            }

            if (schema.properties) {
              const newProperties = { ...schema.properties };

              // 移除不需要的參數
              unwantedParams.forEach((param) => {
                delete newProperties[param];
              });

              // 處理 request 屬性提升
              if (newProperties.request) {
                // 檢查是否只有 request 屬性（或者加上一些已被移除的 unwanted params）
                const remainingKeys = Object.keys(newProperties);
                const onlyHasRequest =
                  remainingKeys.length === 1 && remainingKeys[0] === "request";

                if (onlyHasRequest) {
                  // 情況1: request 有 properties（嵌套物件）
                  if (newProperties.request.properties) {
                    // 清空現有屬性，用 request 的屬性替代
                    schema.properties = newProperties.request.properties;

                    // 處理 required 屬性
                    if (newProperties.request.required) {
                      schema.required = newProperties.request.required;
                    } else {
                      delete schema.required;
                    }
                  }
                  // 情況2: request 是 $ref 引用
                  else if (newProperties.request.$ref) {
                    // 直接將 schema 替換為引用的內容
                    return newProperties.request;
                  }

                  return schema;
                }
              }

              schema.properties = newProperties;

              if (schema.required) {
                schema.required = schema.required.filter(
                  (prop: string) => !unwantedParams.includes(prop)
                );
                if (schema.required.length === 0) {
                  delete schema.required;
                }
              }
            }

            // 處理嵌套結構
            if (schema.items) {
              const cleanedItems = cleanSchema(schema.items);
              if (cleanedItems !== undefined) {
                schema.items = cleanedItems;
              } else {
                delete schema.items;
              }
            }

            if (schema.allOf) {
              schema.allOf = schema.allOf
                .map(cleanSchema)
                .filter((s: any) => s !== undefined);
            }

            if (schema.oneOf) {
              schema.oneOf = schema.oneOf
                .map(cleanSchema)
                .filter((s: any) => s !== undefined);
            }

            if (schema.anyOf) {
              schema.anyOf = schema.anyOf
                .map(cleanSchema)
                .filter((s: any) => s !== undefined);
            }

            return schema;
          };

          // 清理 components/schemas
          if (spec.components?.schemas) {
            // 移除不需要的 schema
            unwantedSchemas.forEach((schemaName) => {
              delete spec.components.schemas[schemaName];
            });

            // 清理其他 schema 中的屬性
            Object.keys(spec.components.schemas).forEach((key) => {
              spec.components.schemas[key] = cleanSchema(
                spec.components.schemas[key]
              );
            });
          }

          // 清理 paths 中的操作
          if (spec.paths) {
            Object.keys(spec.paths).forEach((pathKey) => {
              const pathItem = spec.paths[pathKey];
              Object.keys(pathItem).forEach((method) => {
                const operation = pathItem[method];
                if (!operation || typeof operation !== "object") return;

                // 移除不需要的參數
                if (operation.parameters) {
                  operation.parameters = operation.parameters.filter(
                    (param: any) => !unwantedParams.includes(param.name)
                  );
                }

                // 清理 requestBody
                if (operation.requestBody?.content) {
                  Object.keys(operation.requestBody.content).forEach(
                    (contentType) => {
                      const content =
                        operation.requestBody.content[contentType];
                      if (content.schema) {
                        content.schema = cleanSchema(content.schema);
                      }
                    }
                  );
                }

                // 清理 responses
                if (operation.responses) {
                  Object.keys(operation.responses).forEach((statusCode) => {
                    const response = operation.responses[statusCode];
                    if (response?.content) {
                      Object.keys(response.content).forEach((contentType) => {
                        const content = response.content[contentType];
                        if (content.schema) {
                          content.schema = cleanSchema(content.schema);
                        }
                      });
                    }
                  });
                }

                // 特殊處理：移除操作中直接使用 JWT 作為 requestBody 的情況
                if (
                  operation.requestBody?.content?.[
                    "application/json"
                  ]?.schema?.$ref?.includes("Jwt")
                ) {
                  delete operation.requestBody;
                }
              });
            });
          }

          return spec;
        },
      },
    },
    hooks: {
      afterAllFilesWrite: "prettier --write services/api/index.ts",
    },
  },
});
